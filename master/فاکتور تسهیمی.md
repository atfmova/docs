- [مقدمه](#menu)
- [نمای کلی از فاکتور تسهیمی](#menu)
- [صدور فاکتور تسهیمی](#menu)
- [فرآیند صدور فاکتور تسهیمی](#menu)
- [ساختار فاکتور تسهیمی](#menu)
- [کاهش فاکتور تسهیمی](#menu)
- [لینک‌های مرتبط](#menu)


## مقدمه

**تمام امکانات تسهیم و فروش در پکیج billing قرار دارد.برای اطلاعات بیشتر به [پکیج سرویس‌ها](app/documents/packages/) مراجعه کنید**

در مواردی ممکن است کسب و کار اقدام به فروش محصولات کسب و کار دیگر نماید یا به هر دلیلی بخشی از مبلغ دریافتی به یک یا چند کسب و کار دیگر تعلق داشته باشد. اهمیت این موضوع در امور مالیاتی مشهود و راه حل آن بسیار ضروری است.

<br/>

در این شرایط کسب و کار می تواند نوعی فاکتور با قوانین تسهیم فروش بین کسب و کارهای ذینفع صادر نماید. ظاهراً خریدار تغییری را احساس نخواهد کرد و یک فاکتور تجمیعی را پرداخت می کند ولی در عمل، به تعداد ذینفعان با مبلغ تسهیمی فاکتور صادر شده و مبالغ مستقیماً پس از پرداخت به حساب صنفی آنها منتقل می شود.

<br/>

قوانین زیر در تسهیم وجود دارند:

- فاکتورهای تسهیمی شامل یک فاکتور برای نمایش به مشتری، یک فاکتور برای صادر کننده فاکتور و تعدادی فاکتور برای سایر ذینفعان است. بنابرین لازم است جمع فاکتورهای ذینفعان با فاکتور قابل نمایش به مشتری، برابر باشد. در غیر این صورت هنگام صدور فاکتور خطا دریافت می کنید.
- لازم است کسب و کارهای ذینفع قبلاً اجازه صدور فاکتور توسط کسب و کار دیگر را به او داده باشند.
- پرداخت فاکتورهای زیرمجموعه به صورت جداگانه امکانپذیر نیست و کل فاکتور تسهیم یکجا پرداخت می شود.


![](/assets/images/markdown/facture1.JPG)

<div class="box-end">
</div>

## نمای کلی از فاکتور تسهیمی

علاوه بر موارد بالا فاکتورهای تسهیمی از قوانین فاکتور عادی نیز تبعیت می کنند:

- فاکتوری که با پارامتر verificationNeeded ثبت شده است باید پس از پرداخت کاربر توسط کسب و کار صادرکننده تایید شود. در غیر این صورت پس از مدت یک ساعت مبلغ پرداخت شده به حساب کاربر مرجوع می شود.
- فاکتور پس از بسته شدن قابل تسویه می باشد و دیگر قابل لغو نیست.
- لغو فاکتور قبل از بسته شدن امکان پذیر است و اگر پرداخت شده باشد مبلغ آن به کاربر مرجوع می شود.
- در صورتی که پرداخت امن اعلام شده باشد، لغو و یا تایید فاکتور فقط توسط مشتری امکان پذیر است.

<div class="box-end">
</div>


## صدور فاکتور تسهیمی

کسب و کار معامله گر که لازم است فاکتور تسهیمی صادر نماید باید از جانب کسب و کارهای سهیم دارای مجوز صدور فاکتور باشد. سپس می تواند با استفاده از سرویس issueMultiInvoice تسهیم فروش انجام دهد


<div class="mermaid">
graph TD  
A((شروع))  
A-.->B  
B(دریافت مجوز صدور فاکتور)-.->C  
C(مشخص کردن سهم ذینفعان)-.->D  
D(صدور فاکتور تسهیمی)-.->E  
E(پرداخت)-.->F  
F(استعلام پرداخت)-.->N  
N{انصراف از خرید} 
N-- بله ---O 
O{عودت کامل وجه}
O-- بله ---P
P(ابطال فاکتور)
P-.->M  
N-- خیر ---G 
G(بستن فاکتور)-.->I
I(تسویه حساب)-.->M
O-- خیر ---H
H(کاهش فاکتور تسهیمی)-.->I
M((پایان))
</div>


<div class="box-end">
</div>


## فرآیند صدور فاکتور تسهیمی


![](/assets/images/markdown/facture1.JPG)

<div class="box-end">
</div>



## ساختار فاکتور تسهیمی

ساختار پارامتر data با توجه به شکل، در قالب json به صورت زیر است:

``` json

{
    "redirectURL": "",
    "userId": userId of customer,
    "currencyCode": currency code like "IRR" or "USD",
    "voucherHashs": array of vouchers,     // اگر وجود ندارد این پارامتر ارسال نشود
    "preferredTaxRate": tax to be added between 0 and 1 default is 0.09,
    "verificationNeeded": "true/false",
    "preview": "true/false",
    "mainInvoice": {                // فاکتور به نام خود معامله گر
        "billNumber": business unique bill number,
        "guildCode": GUILD_CODE,
        "metadata": extra data in form of json,
        "description": description,
        "invoiceItemVOs": [ // بندهای فاکتور مربوط به سهم معامله گر
            {
                "productId": the id of product or 0 if no product,
                "price": the share of dealer,
                "quantity": count,
                "description": description of item
            }
            //, ...
        ]
    },
    "subInvoices": [  // فاکتورهای مربوط به سهم سایر کسب و کارهای ذینفع
        {
            "businessId": the id of shareholder business,
            "guildCode": GUILD_CODE,
            "billNumber": unique business bill number,
            "metadata": extra data in form of json,
            "description": description,
            "invoiceItemVOs": [ //بندهای فاکتور کسب و کار ذینفع
                {
                    "productId": the id of product or 0 if no product,
                    "price": the share of shareholder,
                    "quantity": count,
                    "description": description
                }
                //, ...
            ]
        }
        //, ...
    ],
    "customerDescription": the description that customer will see,
    "customerMetadata": extra data for customer in form of json,
    "customerInvoiceItemVOs": [ //  .بندهایی که به مشتری نمایش داده می شوند
        {
            "productId": the id of product or 0 if no product,
            "price": the price to be payed by customer,
            "quantity": count,
            "description": description of item
        }
        //, ...
    ]
}

```
توجه داشته باشید که در مقادیر بالا معادله زیر باید برقرار باشد:

<br/>

```
the share of dealer + the share of shareholder = the price to be payed by customer
```

در پاسخ این درخواست ساختاری به شکل زیر برمی گردد:


``` json
{
    ...
    "result": {
        "id": 609,
        ...
        "customerInvoice": {
            "id": 608,
            "uniqueNumber":"aa7ec3f647bcbfee",
            ...
        },
        "subInvoices": [
            {
                "id": 610,
                ...
                "subInvoice": true
            },
            {
                "id": 611,
                ...
                "subInvoice": true
            }
        ],
        ...
        "subInvoice": false
    }
}
```

برای پرداخت فاکتور تسهیمی توسط مشتری لازم است، شناسه customerInvoice جهت پرداخت ارسال گردد. سایر فاکتورهای متصل قابل پرداخت نیستند. همچنین سایر کسب و کارهای ذینفع فقط فاکتور مربوط به خود را خواهند دید که قابل پرداخت نمی باشند.

<br/>
برای پرداخت فاکتور می توانید مقدار result -> customerInvoice -> id را با انواع روش های پرداخت ارسال نمایید. یا از مقدار result -> customerInvoice-> uniqueNumber برای پرداخت طریق درگاه استفاده نمایید

<br/>

برای تایید فاکتور یا لغو فاکتور یا بستن فاکتور، مقدار result -> customerInvoice -> id را بفرستید.


<div class="tab-start">
</div>

# [C#](#tab/csharp)

``` csharp
try
    {
        var internalServiceCallVo = InternalServiceCallVo.ConcreteBuilder
            .SetToken("{Put your ApiToken}")
            //.SetScVoucherHash({Put your VoucherHash})
            //.SetScApiKey("{Put your ApiKey}")
            .Build();
            var output = new ResultSrv<InvoiceSrv>();
            var ottOutput = GetOtt();
            var mainInvoiceVos = MainInvoiceVo.ConcreteBuilder
                                .SetGuildCode("{Put your GuildCode}")
                                .SetInvoiceItemVOs(new List<InvoiceItemVo>
                                {
                                    InvoiceItemVo.ConcreteBuilder.SetProductId({Put your ProductId}).SetDescription("{Put your 
                                    Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                                })
                                //.SetBillNumber("{Put your BillNumber}")
                                //.SetDescription("{Put your Description}")
                                //.SetMetadata("{Put your Metadata}")
                                .Build();
                              
            var subInvoiceVos = new List<SubInvoiceVo>
                            {
                                SubInvoiceVo.ConcreteBuilder
                                    .SetBusinessId({Put your BusinessId})
                                    .SetGuildCode("{Put your GuildCode}")
                                    .SetInvoiceItemVOs(new List<InvoiceItemVo>
                                    {
                                        InvoiceItemVo.ConcreteBuilder.SetProductId({Put your ProductId}).SetDescription("{Put your 
                                        Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                                    })
                                    //.SetBillNumber("{Put your BillNumber}")
                                    .SetDescription("{Put your Description}")
                                    //.SetMetadata("{Put your Metadata}")
                                    .Build()
                               
                            };
            var customerInvoiceItems = new List<InvoiceItemVo>
                            {
                                InvoiceItemVo.ConcreteBuilder.SetProductId({Put your ProductId}).SetDescription("{Put your 
                                        Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                            };
                            var multiInvoiceData = MultiInvoiceDataVo.ConcreteBuilder
                                .SetMainInvoice(mainInvoiceVos)
                                .SetSubInvoices(subInvoiceVos)
                                .SetCustomerInvoiceItemVOs(customerInvoiceItems)
                                //.SetPreview({Put your Preview})
                                //.SetCurrencyCode("Put your CurrencyCode")
                                //.SetCustomerDescription("{Put your CustomerDescription}")
                                //.SetCustomerMetadata("{Put your CustomerMetadata}")
                                //.SetPreferredTaxRate({Put your PreferredTaxRate})
                                //.SetRedirectUrl("{Put your RedirectUrl}")
                                //.SetUserId({Put your UserId})
                                //.SetVerificationNeeded({Put your VerificationNeeded})
                                //.SetVoucherHashs({Put your VoucherHashs})
                                .Build();
            
            var issueMultiInvoiceVo = IssueMultiInvoiceVo.ConcreteBuilder
                                .SetServiceCallParameters(internalServiceCallVo)
                                .SetOtt(ottOutput.Ott)
                                .SetData(multiInvoiceData)
                                //.SetDelegationHash("{Put your DelegationHash}")
                                //.SetDelegatorId("{Put your DelegatorId}")
                                //.SetForceDelegation("{Put your ForceDelegatio}")
                                .Build();
            BillingService.IssueMultiInvoice(issueMultiInvoiceVo, response => Listener.GetResult(response, out output));
    }
    catch (PodException podException)
    {
        Console.WriteLine($"-- {podException.Code}-an error has occured : 
                              {Environment.NewLine{podException.Message}");
        throw;
    }
catch (Exception exception)
    {
        Console.WriteLine(exception.Message);
        throw;
    }
```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/issueMultiInvoice</div>

# [Java](#tab/java)

``` java
//        List<String> scVoucherHashs =new ArrayList<>();
//        scVoucherHashs.add("RFSFGDYEDYGS");
BaseInfoVo baseInfoVo = new BaseInfoVo.Builder()
                .setToken({token})
                .setToken_issuer(1)
//                .setScApiKey("SDFJKSHFJwshfJshfDJH")
//                .setScVoucherHash(scVoucherHashs)
                .setOtt(OTT)
                .build();


        BillingService billingService = new BillingService();.



        InvoiceItemVO mainInvoiceItemVo = new InvoiceItemVO.Builder(baseInfoVo)
                .setProductId({productId})
                .setDescription({description})
                .setQuantity(new BigDecimal({quantity}))
                .setPrice({price})
                .build();
        List<InvoiceItemVO> mainInvoiceItemVOList = new ArrayList<>();
        mainInvoiceItemVOList.add(mainInvoiceItemVo);
        MainInvoiceVo mainInvoiceVo = new MainInvoiceVo()
                .setGuildCode({guidCode})
                .setDescription({description})
                .setInvoiceItemVOs(mainInvoiceItemVOList);


        InvoiceItemVO subInvoiceItemVo = new InvoiceItemVO.Builder(baseInfoVo)
                .setProductId({productId})
                .setDescription({description})
                .setQuantity(new BigDecimal({quantity}))
                .setPrice({price})
                .build();
        List<InvoiceItemVO> SUBInvoiceItemVoList = new ArrayList<>();
        SUBInvoiceItemVoList.add(subInvoiceItemVo);

        SubInvoiceVO subInvoiceVO = new SubInvoiceVO.Builder(baseInfoVo)
                .setBusinessId({businessId})
                .setGuildCode({guildCode})
                .setInvoiceItemVOs(SUBInvoiceItemVoList)
                .setDescription({description})
                .build();

        List<SubInvoiceVO> subInvoiceVOS = new ArrayList<>();
        subInvoiceVOS.add(subInvoiceVO);

        InvoiceItemVO customerInvoiceItemVo = new InvoiceItemVO.Builder(baseInfoVo)
                .setProductId({productId})
                .setDescription({description})
                .setQuantity(new BigDecimal({quantity}))
                .setPrice({price})
                .build();
        List<InvoiceItemVO> customerInvoiceItems = new ArrayList<>();
        customerInvoiceItems.add(customerInvoiceItemVo);

        MultiInvoiceDataVo multiInvoiceDataVo = new MultiInvoiceDataVo()
                .setMainInvoice(mainInvoiceVo)
                .setSubInvoices(subInvoiceVOS)
                .setCustomerInvoiceItemVOs(customerInvoiceItems)
                .setUserId({userId});
        try {
            IssueMultiInvoiceVo issueMultiInvoiceVo = new IssueMultiInvoiceVo.Builder(baseInfoVo)
                    .setData(multiInvoiceDataVo)
                    .build();
            billingService.issueMultiInvoice(issueMultiInvoiceVo, new OnGetResponseListener<InvoiceSrv>() {
                @Override
                public void onResponse(ResultVo<InvoiceSrv> result) {
                    System.out.println(result.getResult().getId());
                }

                @Override
                public void onFailed(PodException e) {
                    System.out.println("code : " + e.getCode() + "\nmessage : " + e.getMessage());
                }
            });
        } catch (PodException e) {
            System.out.println("code : " + e.getCode() + "\nmessage : " + e.getMessage());
        }


```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/issueMultiInvoice</div>

# [PHP](#tab/php)

``` php
$param =
        [
            ## ========================= *Required Parameters  ======================
            'ott' => 'put ott' , 
            # آرایه حاوی اطلاعات فاکتورها
            'data' =>                       ## commented rows are optional parameters ##
                [
                    // 'redirectURL' => 'put redirect url',
                    // 'userId' => 11111,               # userId of customer
                    // 'currencyCode' => 'like EUR or IRR',
                    // 'voucherHashs' => [],            # array of vouchers  اگر وجود ندارد این پارامتر ارسال نشود
                    // 'preferredTaxRate' => '{put tax, default 0.09}' ,     # tax to be added between 0 and 1 default is 0.09
                    // 'verificationNeeded' => 'true/false',
                    // 'preview' => '',
                    'mainInvoice'=>
                        [
                            // 'billNumber' => 'put bill number',       # business unique bill number
                            'guildCode' => 'put guild code',
                            // 'metadata' => 'extra data in form of json',
                            // 'description' => 'put description',
                            'invoiceItemVOs' =>
                                [
                                    [
                                        'productId' => '{put product id or 0}',   # the id of product or 0 if no product
                                        'price' => '{put price}',     # the share of dealer
                                        'quantity' => '{put quantity}',    # count
                                        'description' => 'put description'
                                    ],
                                ],
                        ],
                    'subInvoices' =>
                        [
                            [
                                'businessId' => '{put business id}',       # the id of shareholder business
                                'guildCode' => 'put guild code',
                                // 'billNumber' => 'put bill number',       # business unique bill number
                                // 'metadata' => 'extra data in form of json',
                                'description' => 'put description',
                                'invoiceItemVOs' =>
                                    [
                                        [
                                            'productId' => '{put product id or 0}',
                                            'price' => '{put price}',         # the share of shareholder
                                            'quantity' => '{put quantity}',
                                            'description' => 'put description'
                                        ],
                                    ],
                            ]
                        ],
                    // customerDescription => 'put customer description',
                    // customerMetadata => 'extra data for customer in form of json',
                    'customerInvoiceItemVOs' =>
                        [
                            [
                                'productId' => '{put product id or 0}',       # the id of product or 0 if no product,
                                'price' => '{put price}',         # the price to be payed by customer
                                'quantity' => '{put quantity}',       # count
                                'description' => 'put description'
                            ]
                        ]
                ],

            ## =========================== Optional Parameters  ===============================
            'delegatorId'       => [],            # شناسه تفویض کنندگان، ترتیب اولویت را مشخص می کند
            'delegationHash'    => [],            # کد تفویض برای اشاره به یک تفویض مشخص
            'forceDelegation'   => false,              # پرداخت فقط از طریق تفویض
            'scVoucherHash'     => ['{Put Service Call Voucher Hashes}'],
            'scApiKey'           => '{Put service call Api Key}',
        ];
    try {
        $result = $BillingService->issueMultiInvoice($param);
        print_r($result);
    } catch (ValidationException $e) {
        print_r($e->getResult());
        print_r($e->getErrorsAsArray());
    } catch (PodException $e) {
        print_r($e->getResult());
    }

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/issueMultiInvoice</div>

# [Nodejs](#tab/nodejs)

``` javascript
let issueMultiInvoiceData = {
  // ------ REQUIRED ------
  data: {
    // redirectURL: 'REDIRECT URL',
    // userId: 0, // USER ID
    // currencyCode: 'CURRENCY', // OPTIONAL
    // voucherHashs: ARRAY OF STRINGS,
    // preferredTaxRate: 0, // OPTIONAL
    // verificationNeeded: true | false, // OPTIONAL
    // preview: true | false, // OPTIONAL
    mainInvoice: {
      // billNumber: 'BILL NUMBER', // OPTIONAL
      guildCode: 'GUILD CODE',
      // metadata: OBJECT, // OPTIONAL
      // description: 'DESCRIPTION', // OPTIONAL
      invoiceItemVOs: [{
        productId: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
    },
    subInvoices: [{
      businessId: 0, // ID
      guildCode: 'GUILD CODE',
      // billNumber: 'BILL NUMBER', // OPTIONAL
      // metadata: OBJECT, // OPTIONAL
      // description: 'DESCRIPTION', // OPTIONAL
      invoiceItemVOs: [{
        productId: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
    }],
    // customerDescription: 'DESCRIPTION', // OPTIONAL
    // customerMetadata: OBJECT, // OPTIONAL
    customerInvoiceItemVOs: [{
      productId: 0,
      price: 0,
      quantity: 0,
      description: 'DESCRIPTION'
    }]
  }

  // ------ OPTIONAL ------
  // delegatorId: [0, 0]
  // delegationHash: ['HASH#1', 'HASH#2']
  // forceDelegation: true | false
  // scVoucherHash: ['HASH#1', 'HASH#2']
  // token: 'API TOKEN'
  // tokenIssuer: 0 | 1
  // scApiKey: ' SC API KEY'
};

podBilling.issueMultiInvoice(issueMultiInvoiceData)
  .then(function (result) {
    console.log('function: issueMultiInvoice ============>', JSON.stringify(result, null, 2), '\n');
  })
  .catch(function (error) {
    console.log('error issueMultiInvoice ============>', error);
  });

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/issueMultiInvoice</div>

<div class="tab-end">
</div>




<div class="box-end">
</div>


## کاهش فاکتور تسهیمی

در فاکتور تسهیمی نیز مانند فاکتور عادی با لغو شدن، کل مبلغ فاکتور و با کاهش، قسمتی از مبلغ به مشتری بازگردانده می شود. ولی در فاکتور تسهیمی برای کاهش لازم است کل سهم ها مجدداً اعلام شوند تا مبلغی که کسر می شود از حساب درست برداشته شود.

<br/>
برای کاهش فاکتور تسهیمی از سرویس reduceMultiInvoice استفاده نمایید:

<br/>

ساختار data ایی که باید برای این سرویس ارسال نمایید به صورت زیر است


``` json
{
    "preferredTaxRate": tax to be added between 0 and 1 default is 0.09,
    "mainInvoice": {                // فاکتور به نام خود معامله گر
        "id": id of main invoice to be edited
        "invoiceItemVOs": [ // بندهای فاکتور مربوط به سهم معامله گر
            {
                "id": the id of item in invoice,
                "productId": the id of product or 0 if no product,
                "price": the share of dealer,
                "quantity": count,
                "description": description of item
            }
            //, ...
        ]
    },
    "subInvoices": [  // فاکتورهای مربوط به سهم سایر کسب و کارهای ذینفع
    {
        "id": id of main invoice to be edited
        "invoiceItemVOs": [ //بندهای فاکتور کسب و کار ذینفع
            {
                "id": the id of item in invoice,
                "productId": the id of product or 0 if no product,
                "price": the share of shareholder,
                "quantity": count,
                "description": description
            }
            //, ...
        ]
    }
    //, ...
    ],
    "customerInvoiceItemVOs": [ //  .بندهایی که به مشتری نمایش داده می شوند
        {
            "id": the id of item in invoice,
            "productId": the id of product or 0 if no product,
            "price": the price to be payed by customer,
            "quantity": count,
            "description": description of item
        }
        //, ...
    ]
}
```
مقدار id در تمام بخش های اطلاعات ارسالی باید مطابق با شناسه های فاکتور اصلی باشد، در غیر این صورت خطا رخ می دهد.


<div class="tab-start">
</div>

# [C#](#tab/csharp)

``` csharp
try
    {
        var internalServiceCallVo = InternalServiceCallVo.ConcreteBuilder
            .SetToken("{Put your ApiToken}")
            //.SetScVoucherHash({Put your VoucherHash})
            //.SetScApiKey("{Put your ApiKey}")
            .Build();
            var output = new ResultSrv<InvoiceSrv>();
            var mainInvoiceVos = ReduceInvoiceItemVo.ConcreteBuilder
                                .SetId({Put your Id})
                                .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                                {
                                    ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                                })
                                .Build();
            
            var subInvoiceVos = new List<ReduceInvoiceItemVo>
                            {
                                ReduceInvoiceItemVo.ConcreteBuilder
                                    .SetId({Put your Id})
                                    .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                                    {
                                        ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your 
                                        Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                                    })
                                    .Build()
                            };
                            var customerInvoiceItems = new List<ReduceInvoiceSubItemVo>
                            {
                                ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity})
                                    .Build()
                            };
            
            var reduceMultiInvoiceDataVo = ReduceMultiInvoiceDataVo.ConcreteBuilder
                                .SetMainInvoice(mainInvoiceVos)
                                .SetSubInvoices(subInvoiceVos)
                                .SetCustomerInvoiceItemVOs(customerInvoiceItems)
                                //.SetPreferredTaxRate({Put your PreferredTaxRate})
                                .Build();
            
            var reduceMultiInvoiceVo = ReduceMultiInvoiceVo.ConcreteBuilder
                                .SetServiceCallParameters(internalServiceCallVo)
                                .SetData(reduceMultiInvoiceDataVo)
                                .Build();
            BillingService.ReduceMultiInvoice(reduceMultiInvoiceVo, response => Listener.GetResult(response, out output));
    }
    catch (PodException podException)
    {
        Console.WriteLine($"-- {podException.Code}-an error has occured : 
                              {Environment.NewLine{podException.Message}");
        throw;
    }
catch (Exception exception)
    {
        Console.WriteLine(exception.Message);
        throw;
    }
```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoice</div>

# [Java](#tab/java)

``` java
//        List<String> scVoucherHashs =new ArrayList<>();
//        scVoucherHashs.add("RFSFGDYEDYGS"); 
 BaseInfoVo baseInfoVo = new BaseInfoVo.Builder()
                .setToken({token})
                .setToken_issuer(1)
//                .setScApiKey("SDFJKSHFJwshfJshfDJH")
//                .setScVoucherHash(scVoucherHashs)
                .build();

        BillingService billingService = new BillingService();



        ReduceInvoiceSubItemVo mainReduceInvoiceSubItemVo = new ReduceInvoiceSubItemVo()
                .setId({id})
                .setDescription({descripttion})
                .setPrice({price})
                .setQuantity(new BigDecimal({quantity}));
        List<ReduceInvoiceSubItemVo> mainReduceInvoiceSubItemVos = new ArrayList<>();
        mainReduceInvoiceSubItemVos.add(mainReduceInvoiceSubItemVo);

        ReduceInvoiceItemVO mainInvoiceVos = new ReduceInvoiceItemVO.Builder(baseInfoVo)
                .setId(32514L)
                .setReduceInvoiceItemVOs(mainReduceInvoiceSubItemVos)
                .build();

        ReduceInvoiceSubItemVo subReduceInvoiceSubItemVo = new ReduceInvoiceSubItemVo()
                .setId({id})
                .setDescription({description})
                .setPrice({price})
                .setQuantity(new BigDecimal({quantity}));
        List<ReduceInvoiceSubItemVo> subrReduceInvoiceSubItemVos = new ArrayList<>();
        subrReduceInvoiceSubItemVos.add(subReduceInvoiceSubItemVo);


        ReduceInvoiceItemVO subReduceInvoiceItemVo = new ReduceInvoiceItemVO.Builder(baseInfoVo)
                .setId({id})
                .setReduceInvoiceItemVOs(subrReduceInvoiceSubItemVos)
                .build();

        List<ReduceInvoiceItemVO> subReduceInvoiceItemVos = new ArrayList<>();
        subReduceInvoiceItemVos.add(subReduceInvoiceItemVo);

        ReduceInvoiceSubItemVo customerreduceInvoiceSubItemVo = new ReduceInvoiceSubItemVo()
                .setId({id})
                .setDescription({description})
                .setPrice({price})
                .setQuantity(new BigDecimal({quantity}));
        List<ReduceInvoiceSubItemVo> customerInvoiceItems = new ArrayList<>();
        customerInvoiceItems.add(customerreduceInvoiceSubItemVo);


        ReduceMultiInvoiceDataVo reduceMultiInvoiceDataVo = new ReduceMultiInvoiceDataVo()
                .setMainInvoice(mainInvoiceVos)
                .setSubInvoices(subReduceInvoiceItemVos)
                .setCustomerInvoiceItemVOs(customerInvoiceItems);
        try {
            ReduceMultiInvoiceVo reduceMultiInvoiceVo = new ReduceMultiInvoiceVo.Builder(baseInfoVo)
                    .setData(reduceMultiInvoiceDataVo)
                    .build();
            billingService.reduceMultiInvoice(reduceMultiInvoiceVo, new OnGetResponseListener<InvoiceSrv>() {
                @Override
                public void onResponse(ResultVo<InvoiceSrv> result) {
                    System.out.println(result.getResult());
                }

                @Override
                public void onFailed(PodException e) {
                    System.out.println("code : " + e.getCode() + "\nmessage : " + e.getMessage());
                }
            });
        } catch (PodException e) {
            System.out.println("code : " + e.getCode() + "\nmessage : " + e.getMessage());
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoice</div>

# [PHP](#tab/php)

``` php
$param =
        [
            ## ============================ *Required Parameters  =========================
            # ***** NOTE : the share of dealer + the share of shareholder = the price to be payed by customer  **** #
            'data' =>
                [
                    'preferredTaxRate' => '{put tax, default 0.09}',            # tax to be added between 0 and 1 default is 0.09
                    'mainInvoice' =>                             # فاکتور به نام خود معامله گر
                        [
                            'id' => '{put invoice id}',                # id of main invoice to be edited
                            'reduceInvoiceItemVOs' =>       # بندهای فاکتور مربوط به سهم معامله گر
                                [
                                    [
                                        'id' => '{put invoice item id}',                 # the id of item in invoice
                                        'price' => '{put price}',                 # the share of dealer
                                        'quantity' => '{put quantity}',                # count
                                        'description' => 'put description of item'
                                    ]
                                ]
                        ],
                    'subInvoices' =>            # فاکتورهای مربوط به سهم سایر کسب و کارهای ذینفع
                        [
                            [
                                'id' => '{put id of sub invoice}',
                                'reduceInvoiceItemVOs' =>       # بندهای فاکتور مربوط به سهم ذینفعان
                                    [
                                        [
                                            'id' => '{put invoice item id}',         # the id of item in invoice
                                            'price' => '{put price}',         # the share of shareholder
                                            'quantity' => '{put quantity}',        # count
                                            'description' => 'put description of item'
                                        ]
                                    ]
                            ]
                        ],
                    'customerInvoiceItemVOs' =>         # بندهایی که به مشتری نمایش داده می شوند
                        [
                            [
                                'id' => '{put invoice item id}',         # the id of item in invoice
                                'price' => '{put price}',         # he price to be payed by customer
                                'quantity' => '{put quantity}',       # count
                                'description' => 'put description of item'
                            ]

                        ],
                ],
            'scVoucherHash'     => ['{Put Service Call Voucher Hashes}'],
            'scApiKey'           => '{Put service call Api Key}',
        ];

    try {
        $result = $BillingService->reduceMultiInvoice($param);
        print_r($result);
    } catch (ValidationException $e) {
        print_r($e->getResult());
        print_r($e->getErrorsAsArray());
    } catch (PodException $e) {
        print_r($e->getResult());
    }

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoice</div>

# [Nodejs](#tab/nodejs)

``` javascript
let reduceMultiInvoiceData = {
  // ------ REQUIRED ------
  data: {
    preferredTaxRate: 0, // CHANGE ZERO TO A VALUE LESS THAN THE ORIGINAL INVOICE
    mainInvoice: {
      id: 0,
      reduceInvoiceItemVOs: [{
        id: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
    },
    subInvoices: [{
      id: 0,
      reduceInvoiceItemVOs: [{
        id: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
    }],
    customerInvoiceItemVOs:
      [{
        id: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
  }
  // ------ OPTIONAL ------
  // scVoucherHash: ['HASH#1', 'HASH#2']
  // token: 'API TOKEN'
  // tokenIssuer: 0 | 1
  // scApiKey: ' SC API KEY'
};

podBilling.reduceMultiInvoice({ data: reduceMultiInvoiceData })
  .then(function (result) {
    console.log('function: reduceMultiInvoice ============>', JSON.stringify(result, null, 2), '\n');
  })
  .catch(function (error) {
    console.log('error reduceMultiInvoice ============>', error);
  });


```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoice</div>

<div class="tab-end">
</div>




<br/>
در صورتی که می خواهید بلافاصله بعد از کاهش فاکتور، مبلغ برگشتی به شماره شبا کاربر منتقل گردد، از سرویس reduceMultiInvoiceAndCashout با همان فرمت data بالا، استفاده نمایید



<div class="tab-start">
</div>

# [C#](#tab/csharp)

``` csharp
try
    {
        var internalServiceCallVo = InternalServiceCallVo.ConcreteBuilder
            .SetToken("{Put your ApiToken}")
            //.SetScVoucherHash({Put your VoucherHash})
            //.SetScApiKey("{Put your ApiKey}")
            .Build();
            var output = new ResultSrv<InvoiceSrv>();
            var mainInvoiceVos = ReduceInvoiceItemVo.ConcreteBuilder
                                .SetId({Put your Id})
                                .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                                {
                                    ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your 
                                    Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                                })
                                .Build();
            
            var subInvoiceVos = new List<ReduceInvoiceItemVo>
                            {
                                ReduceInvoiceItemVo.ConcreteBuilder
                                    .SetId({Put your Id})
                                    .SetReduceInvoiceItemVOs(new List<ReduceInvoiceSubItemVo>
                                    {
                                        ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your Description}").SetPrice(50)
                                            .SetQuantity({Put your Quantity}).Build()
                                    })
                                    .Build()
                            };
                            var customerInvoiceItems = new List<ReduceInvoiceSubItemVo>
                            {
                                ReduceInvoiceSubItemVo.ConcreteBuilder.SetId({Put your Id}).SetDescription("{Put your 
                                Description}").SetPrice({Put your Price}).SetQuantity({Put your Quantity}).Build()
                            };
            
            var reduceMultiInvoiceDataVo = ReduceMultiInvoiceDataVo.ConcreteBuilder
                                .SetMainInvoice(mainInvoiceVos)
                                .SetSubInvoices(subInvoiceVos)
                                .SetCustomerInvoiceItemVOs(customerInvoiceItems)
                                //.SetPreferredTaxRate({Put your PreferredTaxRate})
                                .Build();
            
            var reduceMultiInvoiceAndCashoutVo = ReduceMultiInvoiceAndCashoutVo.ConcreteBuilder
                                .SetServiceCallParameters(internalServiceCallVo)
                                .SetData(reduceMultiInvoiceDataVo)
                                .SetToolCode({Put your ToolCode})
                                .Build();
            BillingService.ReduceMultiInvoiceAndCashout(reduceMultiInvoiceAndCashoutVo, response => Listener.GetResult(response, out output));
    }
    catch (PodException podException)
    {
        Console.WriteLine($"-- {podException.Code}-an error has occured : 
                              {Environment.NewLine{podException.Message}");
        throw;
    }
catch (Exception exception)
    {
        Console.WriteLine(exception.Message);
        throw;
    }
```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoiceAndCashout</div>

# [Java](#tab/java)

``` java
//        List<String> scVoucherHashs =new ArrayList<>();
//        scVoucherHashs.add("RFSFGDYEDYGS"); 
 BaseInfoVo baseInfoVo = new BaseInfoVo.Builder()
                .setToken({token})
                .setToken_issuer(1)
//                .setScApiKey("SDFJKSHFJwshfJshfDJH")
//                .setScVoucherHash(scVoucherHashs)
                .build();

        BillingService billingService = new BillingService();



        ReduceInvoiceSubItemVo mainReduceInvoiceSubItemVo = new ReduceInvoiceSubItemVo()
                .setId({id})
                .setDescription({description})
                .setPrice({price})
                .setQuantity(new BigDecimal({quantity}));
        List<ReduceInvoiceSubItemVo> mainReduceInvoiceSubItemVol = new ArrayList<>();
        mainReduceInvoiceSubItemVol.add(mainReduceInvoiceSubItemVo);
        ReduceInvoiceItemVO mainInvoiceVos = new ReduceInvoiceItemVO.Builder(baseInfoVo)
                .setId(32734L)
                .setReduceInvoiceItemVOs(mainReduceInvoiceSubItemVol)
                .build();


        ReduceInvoiceSubItemVo subReduceInvoiceSubItemVo = new ReduceInvoiceSubItemVo()
                .setId({id})
                .setDescription({description})
                .setPrice({price})
                .setQuantity(new BigDecimal({quantity}));
        List<ReduceInvoiceSubItemVo> subReduceInvoiceSubItemVoList = new ArrayList<>();
        subReduceInvoiceSubItemVoList.add(subReduceInvoiceSubItemVo);


        ReduceInvoiceItemVO subReduceInvoiceItemVo = new ReduceInvoiceItemVO.Builder(baseInfoVo)
                .setId(32735L)
                .setReduceInvoiceItemVOs(subReduceInvoiceSubItemVoList)
                .build();
        List<ReduceInvoiceItemVO> subInvoiceVos = new ArrayList<>();
        subInvoiceVos.add(subReduceInvoiceItemVo);

        ReduceInvoiceSubItemVo customerReduceInvoiceSubItemVo = new ReduceInvoiceSubItemVo()
                .setId({id})
                .setDescription({description})
                .setPrice({price})
                .setQuantity(new BigDecimal({quantity}));
        List<ReduceInvoiceSubItemVo> customerInvoiceItems = new ArrayList<>();
        customerInvoiceItems.add(customerReduceInvoiceSubItemVo);

        ReduceMultiInvoiceDataVo reduceMultiInvoiceDataVo = new ReduceMultiInvoiceDataVo()
                .setMainInvoice(mainInvoiceVos)
                .setCustomerInvoiceItemVOs(customerInvoiceItems)
                .setSubInvoices(subInvoiceVos);


        try {
            ReduceMultiInvoiceAndCashoutVo reduceMultiInvoiceAndCashoutVo = new ReduceMultiInvoiceAndCashoutVo.Builder(baseInfoVo)
                    .setData(reduceMultiInvoiceDataVo)
                    .setToolCode({toolCode})
                    .build();
            billingService.reduceMultiInvoiceAndCashout(reduceMultiInvoiceAndCashoutVo, new OnGetResponseListener<InvoiceSrv>() {
                @Override
                public void onResponse(ResultVo<InvoiceSrv> result) {
                    System.out.println(result.getResult());
                }

                @Override
                public void onFailed(PodException e) {
                    System.out.println("code : " + e.getCode() + "\nmessage : " + e.getMessage());
                }
            });
        } catch (PodException e) {
            System.out.println("code : " + e.getCode() + "\nmessage : " + e.getMessage());
        }

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoiceAndCashout</div>

# [PHP](#tab/php)

``` php
$param =
        [
            ## ============================ *Required Parameters  =========================
            # ***** NOTE : the share of dealer + the share of shareholder = the price to be payed by customer  **** #
            'data' =>
                [
                    'preferredTaxRate' => '{put tax, default 0.09}',            # tax to be added between 0 and 1 default is 0.09
                    'mainInvoice' =>                             # فاکتور به نام خود معامله گر
                        [
                            'id' => '{put id of main invoice}',                # id of main invoice to be edited
                            'reduceInvoiceItemVOs' =>       # بندهای فاکتور مربوط به سهم معامله گر
                                [
                                    [
                                        'id' => '{put invoice item id}',                 # the id of item in invoice
                                        'price' => '{put price}',                 # the share of dealer
                                        'quantity' => '{put quantity}',                # count
                                        'description' => 'put description of item'
                                    ]
                                ]
                        ],
                    'subInvoices' =>            # فاکتورهای مربوط به سهم سایر کسب و کارهای ذینفع
                        [
                            [
                                'id' => '{put id of sub invoice}',
                                'reduceInvoiceItemVOs' =>       # بندهای فاکتور مربوط به سهم ذینفعان
                                    [
                                        [
                                            'id' => '{put invoice item id}',         # the id of item in invoice
                                            'price' => '{put price}',         # the share of shareholder
                                            'quantity' => '{put quantity}',        # count
                                            'description' => 'put description of item'
                                        ]
                                    ]
                            ]
                        ],
                    'customerInvoiceItemVOs' =>         # بندهایی که به مشتری نمایش داده می شوند
                        [
                            [
                                'id' => '{put invoice item id}',         # the id of item in invoice
                                'price' => '{put price}',         # he price to be payed by customer
                                'quantity' => '{put quantity}',       # count
                                'description' => 'put description of item'
                            ]

                        ],
                ],
            'scVoucherHash'     => ['{Put Service Call Voucher Hashes}'],
            'scApiKey'           => '{Put service call Api Key}',
        ];
    try {
        $result = $BillingService->reduceMultiInvoiceAndCashOut($param);
        print_r($result);
    } catch (ValidationException $e) {
        print_r($e->getResult());
        print_r($e->getErrorsAsArray());
    } catch (PodException $e) {
        print_r($e->getResult());
    }

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoiceAndCashout</div>

# [Nodejs](#tab/nodejs)

``` javascript
let reduceMultiInvoiceAndCashOutData = {
  // ------ REQUIRED ------
  data: {
    preferredTaxRate: 0, // CHANGE ZERO TO A VALUE LESS THAN THE ORIGINAL INVOICE
    mainInvoice: {
      id: 0,
      reduceInvoiceItemVOs: [{
        id: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
    },
    subInvoices: [{
      id: 0,
      reduceInvoiceItemVOs: [{
        id: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
    }],
    customerInvoiceItemVOs:
      [{
        id: 0,
        price: 0,
        quantity: 0,
        description: 'DESCRIPTION'
      }]
  }
  // ------ OPTIONAL ------
  // scVoucherHash: ['HASH#1', 'HASH#2']
  // token: 'API TOKEN'
  // tokenIssuer: 0 | 1
  // scApiKey: ' SC API KEY'
};

podBilling.reduceMultiInvoiceAndCashOut(reduceMultiInvoiceAndCashOutData)
  .then(function (result) {
    console.log('function: reduceMultiInvoiceAndCashOut ============>', JSON.stringify(result, null, 2), '\n');
  })
  .catch(function (error) {
    console.log('error reduceMultiInvoiceAndCashOut ============>', error);
  });

```
<div class="swaggerLink">http://sandbox.pod.land:8080/apidocs/swagger-ui.html?srv=/nzh/biz/reduceMultiInvoiceAndCashout</div>

<div class="tab-end">
</div>

<div class="box-end">
</div>


## لینک‌های مرتبط

- [مقدمه](/app/documents/introduction/)
- [مفاهیم](/app/documents/concepts/)
- [استاندارد و خطاها](/app/documents/errors/)
- [شروع به کار](/app/documents/get-started/)
- [پکیج‌ها](/app/documents/packages/)

<div class="box-end">
</div>

