خرید (فاکتور) [](#)
-------------------

 **خرید در یک نگاه**

 خرید فعالیتی است که مشتری، محصول یا خدماتی را که توسط کسب‌و‌کاری ارائه شده است را جستجو و در ازای پرداخت هزینه استفاده می‌کند. در خرید آنلاین، فرآیند جستجو، تعامل فروشنده و مشتری، پرداخت و رهگیری در بستر شبکه اینترنت انجام می‌شود. مراحل خرید پس از انتخاب محصول توسط مشتری تا اتمام فرآیند توسط فروشنده به طور اجمالی شامل این مراحل است.

 



 

 **صدور فاکتور**

 هرگونه پرداخت در پلتفرم پاد، از طریق فاکتور صورت می گیرد. در این بخش صدور فاکتور با استفاده از توکن کسب و کار شرح داده شده و می توان با خروجی حاصل از این متد، کاربر را به راحتی به درگاه پرداخت هدایت نمود. برای صدور فاکتور از سرویس issueInvoice استفاده نمایید.  
 مقدار api\_token (توکن کسب و کار) را از پنل [ مدیریت کسب و کار ](https://panel.pod.land/Businesses/Keys) دریافت نمایید.

 نکته
-----

1. اگر محصولی که برای آن فاکتور ثبت می کنید در سیستم ثبت شده نیست، ProductId را با مقدار صفر وارد نمایید.
2. برای بدست آوردن لیست اصناف می توانید از سرویس [guildList](http://docs.pod.land/v1.0.0.1/PODSDKs/services/3850/common#guildList) استفاده نمایید.
3. اکثر عملیات مربوط به فاکتور نیاز به ott دارند که میتوانید آن را از آخرین درخواست به پلتفرم یا از طریق سرویس دریافت نمایید. فقط دقت نمایید که توکنی که با آن ott می گیرید با توکنی که در درخواست بعدی باید استفاده شود، یکی باشد.
4. توجه داشته باشید مقدار ott از api\_token متفاوت است، مقدار ott را میتوانید از تابع issueInvoice هم دریافت نمایید و مجددا در سرویس صدور فاکتور فراخوانی نمایید.
 


 فاکتورهایی که در این حالت صادر می شوند، عادی هستند و پس از پرداخت توسط مشتری، اعتبار کسب و کار افزایش می یابد. با دریافت [لیست فاکتورها](#list) می توانید وضعیت آنها را مشاهده نمایید.

 در هنگام فراخوانی سرویس صدور فاکتور، ممکن است با خطاهایی مواجه شوید که در مستند ذیل به رایج ترین آن ها اشاره شده است:

 |errorCode |دلیل خطا |شرح |
|---|---|---|
  |10 |INVALID\_DATE |ارسال فرمت اشتباه تاریخ در پارامتر deadLine |
  |19 |DUPLICATE\_BILLNUMBER |شماره صورتحساب تکراری می باشد. |
  |21 |client not authenticated |ارسال اشتباه مقدار توکن |
  |25 |DUPLICATE\_CANCELED\_BILLNUMBER |اگر شماره قبض لحاظ شده، متعلق به فاکتور کنسل شده ای با همین شماره قبض باشد، این خطا را دریافت خواهید نمود. |
  |37 |INVALID\_ELEMENT\_CODE |کد صنف با فرمت صحیح موجود در پنل مدیریت کسب و کار، وارد نشده است. |
  |39 |PERMISSION\_ACCESS\_DENIED |در صورت عدم ارسال پارامتر ott با این خطا رو به رو می شوید. به منظور بازنشانی کردن ott ، سرویس دریافت توکن یکبار مصرف فراخوانی نمایید. |
  |53 |INVALID\_BUSINESS\_GUILD |اگر صنف انتخابی در پنل کسب و کار نباشد این خطا را دریافت خواهید نمود. ابتدا باید آن صنف را از پنل مدیریت کسب و کار، اضافه نمایید. |
  |56 |INVALID\_GUILD\_AMOUNT |پارامتر کد صنف به درستی ارسال نشده است. |
  |66 |INVOICE\_SAME\_BIZ\_AND\_CUSTOMER |اگر توکن(\_token\_) و شناسه ی کاربر(userId) ای که استفاده می نمایید متعلق به یک کسب و کار باشد، این خطا را دریافت می کنید. چرا که صدور فاکتور از کسب و کار خودتان برای خودتان امکان پذیر نیست. به مستند افزودن کسب و کار واسط مراجعه نمایید. کسب و کار جدیدی ثبت نمایید، و به این کسب وکار مجوز صدور فاکتور برای یک محصول خاص(ارجاع به مستند مجوز فروش محصول)، اعطا نمایید و سپس نسبت به صدور فاکتور اقدام نمایید. |
  |999 |UNKNOWN |خطای داخلی |
   **نمایش پیش فاکتور**

 در پلتفرم کسب و کار، فاکتورهایی که پرداخت می شوند به صورت سالانه شماره سریال دریافت می نمایند، بنابرین کسب و کار می تواند برای امور مالی خود به آن شماره سریال استناد نماید. در برخی شرایط، ممکن است کسب و کار بخواهد فاکتور تا زمانی که اقدام به پرداخت آن نشده اصلاً ثبت نگردد. بدین منظور با استفاده از سرویس createPreInvoice می تواند پیش فاکتور را ثبت نماید. به محض اینکه مشتری، فاکتور را با کیف پول خود پرداخت نماید یا برای پرداخت وارد درگاه بانکی شود، فاکتور ثبت می گردد. در صورتی که مشتری پرداخت را از طریق درگاه لغو نماید یا اشکالی در پرداخت او به وجود آید، فاکتور به صورت خودکار لغو خواهد شد.

 پارامترهای ارسالی در این درخواست و کارکرد آنها مشابه پارامترهای صدور فاکتور هستند. بنابرین در صورت نیاز میتوانید با مراجعه به بخش [صدور فاکتور](#issueInvoice) اطلاعات بیشتری کسب نمایید.

 در پاسخ این سرویس کد hash به شما برگشت داده می شود که شما باید کاربر را به آدرس زیر هدایت کنید
```

https://pay.pod.land/v1/pbc/preinvoice/{HASH}
```

 **لیست فاکتورها**

 برای مشاهده فاکتورهایی که کسب و کار شما صادر نموده و وضعیت آنها می توانید به پنل مدیریت کسب و کار خود به آدرس https://panel.pod.land مراجعه نمایید و از منوی « مالی ، فاکتورها » آنها را مشاهده نمایید. این قسمت امکان فیلتر یا جستجو در شرح فاکتورها را نیز دارد.  
 همچنین می توانید برای استفاده در برنامه خود، از API زیر استفاده نمایید.

 نکته
-----

در صورتی که بخواهید وضعیت پرداخت یک فاکتور (**استعلام پرداخت**) را بررسی کنید، تنها کافیست تا پارامتر **id** را برابر با شناسه فاکتور مورد نظر قرار دهید.



 

 **جستجو در متادیتا فاکتورها**

 همچنین برای جستجو در متادیتای ثبت شده برای فاکتور می توانید از سرویس زیر استفاده نمایید

 در قسمت metaQuery مقادیر درخواستی خود را به فرم json با استفاده از توصیحات [جستجوی متادیتا](https://docs.pod.land/document/Developer-CustomPost-SearchMetadata) ارسال نمایید.

 

 **تایید پرداخت فاکتور**

 در صورتی که در صدور فاکتور پارامتر verificationNeeded را با مقدار true ارسال نموده باشید، پرداخت سه مرحله ای فعال شده است. به این معنی که پس از هدایت کاربر به صفحه پرداخت(فقط در صورت پرداخت فاکتور از طریق اتصال به درگاه می توانید سرویس تایید فاکتور را صدا بزنید) و دریافت پاسخ در redirectUri لازم است پرداخت توسط کسب و کار با استفاده از سرویس verifyInvoice تایید شود.  
 بدین ترتیب در صورتی که در فرایند پرداخت اشکالی به وجود بیاید یا به علت قطعی شبکه، عملیات به redirectUri منتقل نشود، کسب و کار نباید پرداخت را تایید نماید و اگر مبلغی توسط مشتری پرداخت شده باشد، ظرف مدت یک ساعت به حساب کیف پول او برگشت زده خواهد شد. در طول این یک ساعت، فاکتور با وضعیت «در انتظار تایید» در پنل مدیریت کسب و کار قابل مشاهده است.





 

 **بستن فاکتور**

 فاکتور هایی که بسته شوند دیگر قابل ابطال نیستند. برای اینکه بتوانید مبالغ فروش خود را تسویه نمایید لازم است حتما فاکتورها را ببندید.  
 چنان چه فاکتورها به صورت safe=true صادر شده باشد و یا فاکتور متعلق به کسب و کار شما نباشد پیغام خطای " اجازه بستن این فاکتور را ندارید " دریافت خواهید کرد.

 

 **تایید و بستن فاکتور در یک مرحله**

 با فراخوانی سرویس verifyAndCloseInvoice، می‌توانید همزمان تایید و بستن فاکتور را انجام دهید  
 هنگام استفاده از این وب سرویس به نکات زیر دقت نمایید:

1. مبلغ فاکتور بعد از واریز شاپرک قابل برداشت خواهد بود
2. بعد از فراخوانی این سرویس امکان کاهش فاکتور یا لغو فاکتور وجود ندارد
3. جهت واریز وجه به مشتری پرداخت کننده فاکتور، لازم است از سرویس transferByInvoice استفاده نمایید که شامل کارمزد می باشد.
4. بعد از فراخوانی این سرویس وضعیت فاکتور دیگر تغییر نخواهد کرد
 


 **ابطال فاکتور**

 در صورتی که به هر دلیل بخواهید فاکتوری را ابطال کنید می توانید از سرویس cancelInvoice استفاده کنید.  
 در صورتی که فاکتور باطل شود، دیگر قابل پرداخت نیست و در صورتی که قبلا پرداخت شده باشد، مبلغ آن به پرداخت کننده برگشت خواهد خورد.  
 توجه: در صورتی که فاکتور با شرایط safe=true صادر شده باشد، فقط پرداخت کننده می تواند فاکتور را کنسل کند و اگر safe نباشد فقط صادر کننده فاکتور مجاز به کنسلی فاکتور می باشد.

 

 **کاهش فاکتور**

 در مواردی ممکن است نیاز به تغییری در بندهای فاکتور داشته باشید. در صورتی که فاکتور پرداخت نشده است، فاکتور قبلی را [باطل (cancel)](#cancelInvoice) نمایید و فاکتور جدیدی صادر کنید. اگر فاکتور پرداخت شده است(در صورتی که باید پول بیشتری از مشتری دریافت نمایید)، لازم است فاکتوری جداگانه به مبلغ افزوده شده، با ذکر دلیل صادر نموده و مشتری را مجددا برای پرداخت هدایت نمایید. در برخی مواقع لازم است مبلغی از فاکتور پرداخت شده به مشتری بازگردانده شود. برای این منظور از سرویس ReduceInvoice برای اصلاح فاکتور پرداخت شده استفاده نمایید.

 **توجه:** تعداد پارامترهای \[\]invoiceItemId و \[\]itemDescription و \[\]price و \[\]quantity باید با هم برابر و برابر با تعداد آنها در فاکتور اول باشد.

 به این ترتیب موارد زیر اجرا می شوند:

- فاکتور اول باطل شده و یک فاکتور جدید با همان خصوصیات قبلی و با اصلاحات بالا صادر شده و billNumber فاکتور اول Null می شود.
- فیلد edited در فاکتور اول true می شود.
- در فاکتور جدید مقدار editedInvoiceId برابر با id فاکتور اول قرار می گیرد.
- در لیست فاکتورها فقط فاکتورهای ویرایش نشده نمایش داده می شوند مگر اینکه دقیقاً id فاکتور ویرایش شده مورد نظر ارسال شود.
- فاکتور ویرایش شده قابل بستن یا باطل شدن نیست و لازم است فاکتور نهایی بسته یا باطل شود.
- اگر فاکتور اول با مقدار مالیات پیشفرض سیستم ثبت شده باشد و در اصلاح فاکتور نیز داده نشود، در صورتی که مالیات پیشفرض سیستم عوض شده باشد، فاکتور دوم نیز با مالیات پیشفرض جدید ثبت خواهد شد.
 


 **دریافت فایل لیست فاکتورها**

 



 

 برای مشاهده فاکتورهایی که کسب و کار شما صادر نموده و وضعیت آنها می توانید به پنل مدیریت کسب و کار خود به آدرس https://panel.pod.land مراجعه نمایید و از منوی « مالی ، فاکتورها » آنها را مشاهده نمایید. این قسمت امکان فیلتر یا جستجو در شرح فاکتورها را نیز دارد.  
 همچنین می توانید برای استفاده در برنامه خود، از API زیر استفاده نمایید.  

 **دریافت فایل خروجی فاکتورها**

 توسط سرویس getInvoiceListAsFile امکان جستجو و دریافت فایل فاکتورهای صادر شده توسط کسب و کار قابل انجام خواهد بود و میتوانید ازخروجی این سرویس یک فایل اکسل با فیلترهای متنوع دریافت کنید.  
 بدیهی است در سرویس بالا با توجه به اختیاری بودن اکثر فیلترها اگر هیچ یک از فیلترهای اختیاری ارسال نشود گزارش حجیم تر و کاملتری در اکسل خواهید داشت و هرچه تعداد فیلترها بیشتر باشد گزارش دقیق تر و سبک تری در اختیار خواهید داشت.  
 با فراخوانی این سرویس درخواست شما ثبت شده و بعد از مدتی گزارش آماده دریافت است، که برای دریافت گزارش می توانید از سرویس [دریافت وضعیت خروجی فاکتورها](#getExportList) استفاده نمایید.

 

 **دریافت وضعیت خروجی فاکتورها**

 جهت مشاهده وضعیت هریک از سرویس های درخواست داده شده خود میتوانید از سرویس getExportList استفاده نمایید.  
 در صورتی که هر یک از گزارش ها آماده باشد وضعیت (statusCode) آن برابر با **EXPORT\_SERVICE\_STATUS\_SUCCESSFUL** است، که به این معنی است شما می توانید آن را دانلود نمایید.  
 برای دانلود کافیست تا **resultFile.hashCode** و **resultFile.id** را از خروجی دریافت و در آدرس زیر قرار دهید.
```

https://core.pod.land/nzh/file/?fileId=yourFileId&hashCode=YourHashCode
```

 

 **خرید امن**

 امکان پرداخت امن برای نوع خاصی از کسب و کارها که امکان لغو یا تایید خرید را تا آخرین لحظه بر عهده مشتری می‌گذارند (مانند فروشندگان واسطه) بسیار مناسب است. در این حالت مشتری می تواند بعد از پرداخت فاکتور تا زمان اعلام شده توسط کسب و کار، آن را لغو و پول خورد را پس بگیرد یا آن را تایید نماید تا فروشنده پول خود را دریافت کند.  
 برای فعال کردن این قابلیت تنها کافیست تا در زمان [صدور فاکتور](#issueInvoice) پارامتر **safe** را برابر **true** قرار دهید.

 



 

 |→ پرداخت فاکتور |عملیات حساب کاربری ← |
|---|---|
